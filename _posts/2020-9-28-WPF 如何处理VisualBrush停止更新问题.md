---
title: "WPF 如何处理VisualBrush停止更新问题"
author: 胡承
date: 2020-09-28 9:35:3 +0800
CreateTime: 2020-09-28 9:35:3 +0800
categories: C# .NET WPF
---

工作忙，博客都忘了写。很多零散的知识点，虽然比较陈旧，发现还是很多人没有遇到过。今天就分享一下，WPF 如何处理VisualBrush停止更新问题。

<!-- more -->

WPF的`VisualBrush`相信很多同学都有用过，他可以很方便的将我们的`Visual`作为背景显示到另外一个`Visual`上面。

通常情况下，我们的`VisualBrush`都是在当前界面上实时显示的，这种情况，他可以工作的很好。但是如果我们需要镜像的`Visual`不在视觉树上面呢？


## 实际应用场景举例

我们需要做一个带有预览功能的控件，分别表示WPF对于的不同的画布（Slide)页面。而当前显示的页面（Slide)只有一个,但是作为预览页面来讲，他需要显示所有的页面。

实现方法简单的有以下两种：

1. 使用`VisualBrush`做动态跟踪。
1. 截图。

截图方案存在以下缺点：
1. 截图本身性能差
1. 需要经常刷新
1. 占用内存

所以我们就不用截图方案了。

用`VisualBrush`我们会发现未在视觉树上的预览图和我们实际的`Visual`显示可能会不一致。

不在视觉树上如图所示：

![](https://i.loli.net/2020/09/28/AFhoL6J8OlVipjw.jpg)


在视觉树上以后，如图所示：

![](https://i.loli.net/2020/09/28/zZ5eS1qjBksxrOE.jpg)

我们会发现，缩略图显示的并不是整个画布的全貌，而是里面的部分放大的显示效果。

这里的主要原因是因为画布的宽度和高度是Double.NaN。所以`VisualBrush`也是根据可渲染的子元素来进行布局计算，显示的内容就不一致。

## 解决方法

解决此问题有两种思路：
1. 给画布设置固定的宽高值。
1. 给画布添加一个宽高正确的子元素。

另外对于画刷不更新的问题，这里就不贴图了。解决思路也很简单，只需要对目标背景重新赋值即可解决。

```cs
    //item表示一个包含Slide的对象，给预览控件做绑定的
    var tmp = item.Slide;
    item.Slide = null;
    item.Slide = tmp;
```

如有遇到其他问题，请在评论区留言。